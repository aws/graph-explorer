{"version":3,"names":["hasOwnDecorators","node","decorators","length","hasDecorators","body","some","prop","key","value","t","objectProperty","identifier","method","objectMethod","blockStatement","takeDecorators","result","arrayExpression","map","decorator","expression","undefined","getKey","computed","isIdentifier","stringLiteral","name","String","extractElementDescriptor","file","classRef","superRef","path","isMethod","isClassMethod","isPrivate","buildCodeFrameError","type","scope","isTSDeclareMethod","ReplaceSupers","methodPath","objectRef","refToPreserve","replace","properties","kind","static","booleanLiteral","filter","Boolean","id","transformed","toExpression","push","nameFunction","isClassProperty","template","statements","ast","buildUndefinedNode","remove","objectExpression","addDecorateHelper","addHelper","err","code","message","buildDecoratedClass","ref","elements","initializeId","generateUidIdentifier","isDeclaration","isStrict","isInStrictMode","superClass","cloneNode","superId","generateUidIdentifierBasedOnNode","classDecorators","definitions","element","abstract","wrapperCall","nullLiteral","arguments","directives","directive","directiveLiteral","replacement","classPathDesc","statement","instanceNodes","wrapClass","replaceWith","get"],"sources":["../src/decorators.ts"],"sourcesContent":["// TODO(Babel 8): Remove this file\n\nimport { types as t, template } from \"@babel/core\";\nimport type { File } from \"@babel/core\";\nimport type { NodePath } from \"@babel/traverse\";\nimport ReplaceSupers from \"@babel/helper-replace-supers\";\nimport nameFunction from \"@babel/helper-function-name\";\n\ntype Decorable = Extract<t.Node, { decorators?: t.Decorator[] | null }>;\n\nexport function hasOwnDecorators(node: t.Node) {\n  // @ts-expect-error(flow->ts) TODO: maybe we could add t.isDecoratable to make ts happy\n  return !!(node.decorators && node.decorators.length);\n}\n\nexport function hasDecorators(node: t.Class) {\n  return hasOwnDecorators(node) || node.body.body.some(hasOwnDecorators);\n}\n\nfunction prop(key: string, value?: t.Expression) {\n  if (!value) return null;\n  return t.objectProperty(t.identifier(key), value);\n}\n\nfunction method(key: string, body: t.Statement[]) {\n  return t.objectMethod(\n    \"method\",\n    t.identifier(key),\n    [],\n    t.blockStatement(body),\n  );\n}\n\nfunction takeDecorators(node: Decorable) {\n  let result: t.ArrayExpression | undefined;\n  if (node.decorators && node.decorators.length > 0) {\n    result = t.arrayExpression(\n      node.decorators.map(decorator => decorator.expression),\n    );\n  }\n  node.decorators = undefined;\n  return result;\n}\n\ntype AcceptedElement = Exclude<ClassElement, t.TSIndexSignature>;\ntype SupportedElement = Exclude<\n  AcceptedElement,\n  | t.ClassPrivateMethod\n  | t.ClassPrivateProperty\n  | t.ClassAccessorProperty\n  | t.StaticBlock\n>;\n\nfunction getKey(node: SupportedElement) {\n  if (node.computed) {\n    return node.key;\n  } else if (t.isIdentifier(node.key)) {\n    return t.stringLiteral(node.key.name);\n  } else {\n    return t.stringLiteral(\n      String(\n        // A non-identifier non-computed key\n        (node.key as t.StringLiteral | t.NumericLiteral | t.BigIntLiteral)\n          .value,\n      ),\n    );\n  }\n}\n\nfunction extractElementDescriptor(\n  file: File,\n  classRef: t.Identifier,\n  superRef: t.Identifier,\n  path: NodePath<AcceptedElement>,\n) {\n  const isMethod = path.isClassMethod();\n  if (path.isPrivate()) {\n    throw path.buildCodeFrameError(\n      `Private ${\n        isMethod ? \"methods\" : \"fields\"\n      } in decorated classes are not supported yet.`,\n    );\n  }\n  if (path.node.type === \"ClassAccessorProperty\") {\n    throw path.buildCodeFrameError(\n      `Accessor properties are not supported in 2018-09 decorator transform, please specify { \"version\": \"2021-12\" } instead.`,\n    );\n  }\n  if (path.node.type === \"StaticBlock\") {\n    throw path.buildCodeFrameError(\n      `Static blocks are not supported in 2018-09 decorator transform, please specify { \"version\": \"2021-12\" } instead.`,\n    );\n  }\n\n  const { node, scope } = path as NodePath<SupportedElement>;\n\n  if (!path.isTSDeclareMethod()) {\n    new ReplaceSupers({\n      methodPath: path as NodePath<\n        Exclude<SupportedElement, t.TSDeclareMethod>\n      >,\n      objectRef: classRef,\n      superRef,\n      file,\n      refToPreserve: classRef,\n    }).replace();\n  }\n\n  const properties: t.ObjectExpression[\"properties\"] = [\n    prop(\"kind\", t.stringLiteral(t.isClassMethod(node) ? node.kind : \"field\")),\n    prop(\"decorators\", takeDecorators(node as Decorable)),\n    prop(\"static\", node.static && t.booleanLiteral(true)),\n    prop(\"key\", getKey(node)),\n  ].filter(Boolean);\n\n  if (t.isClassMethod(node)) {\n    const id = node.computed\n      ? null\n      : (node.key as\n          | t.Identifier\n          | t.StringLiteral\n          | t.NumericLiteral\n          | t.BigIntLiteral);\n    const transformed = t.toExpression(node);\n    properties.push(\n      prop(\n        \"value\",\n        nameFunction({ node: transformed, id, scope }) || transformed,\n      ),\n    );\n  } else if (t.isClassProperty(node) && node.value) {\n    properties.push(\n      method(\"value\", template.statements.ast`return ${node.value}`),\n    );\n  } else {\n    properties.push(prop(\"value\", scope.buildUndefinedNode()));\n  }\n\n  path.remove();\n\n  return t.objectExpression(properties);\n}\n\nfunction addDecorateHelper(file: File) {\n  try {\n    return file.addHelper(\"decorate\");\n  } catch (err) {\n    if (err.code === \"BABEL_HELPER_UNKNOWN\") {\n      err.message +=\n        \"\\n  '@babel/plugin-transform-decorators' in non-legacy mode\" +\n        \" requires '@babel/core' version ^7.0.2 and you appear to be using\" +\n        \" an older version.\";\n    }\n    throw err;\n  }\n}\n\ntype ClassElement = t.Class[\"body\"][\"body\"][number];\ntype ClassElementPath = NodePath<ClassElement>;\n\nexport function buildDecoratedClass(\n  ref: t.Identifier,\n  path: NodePath<t.Class>,\n  elements: ClassElementPath[],\n  file: File,\n) {\n  const { node, scope } = path;\n  const initializeId = scope.generateUidIdentifier(\"initialize\");\n  const isDeclaration = node.id && path.isDeclaration();\n  const isStrict = path.isInStrictMode();\n  const { superClass } = node;\n\n  node.type = \"ClassDeclaration\";\n  if (!node.id) node.id = t.cloneNode(ref);\n\n  let superId: t.Identifier;\n  if (superClass) {\n    superId = scope.generateUidIdentifierBasedOnNode(node.superClass, \"super\");\n    node.superClass = superId;\n  }\n\n  const classDecorators = takeDecorators(node);\n  const definitions = t.arrayExpression(\n    elements\n      .filter(\n        element =>\n          // @ts-expect-error Ignore TypeScript's abstract methods (see #10514)\n          !element.node.abstract && element.node.type !== \"TSIndexSignature\",\n      )\n      .map(path =>\n        extractElementDescriptor(\n          file,\n          node.id,\n          superId,\n          // @ts-expect-error TS can not exclude TSIndexSignature\n          path,\n        ),\n      ),\n  );\n\n  const wrapperCall = template.expression.ast`\n    ${addDecorateHelper(file)}(\n      ${classDecorators || t.nullLiteral()},\n      function (${initializeId}, ${superClass ? t.cloneNode(superId) : null}) {\n        ${node}\n        return { F: ${t.cloneNode(node.id)}, d: ${definitions} };\n      },\n      ${superClass}\n    )\n  ` as t.CallExpression & { arguments: [unknown, t.FunctionExpression] };\n\n  if (!isStrict) {\n    wrapperCall.arguments[1].body.directives.push(\n      t.directive(t.directiveLiteral(\"use strict\")),\n    );\n  }\n\n  let replacement: t.Node = wrapperCall;\n  let classPathDesc = \"arguments.1.body.body.0\";\n  if (isDeclaration) {\n    replacement = template.statement.ast`let ${ref} = ${wrapperCall}`;\n    classPathDesc = \"declarations.0.init.\" + classPathDesc;\n  }\n\n  return {\n    instanceNodes: [template.statement.ast`${t.cloneNode(initializeId)}(this)`],\n    wrapClass(path: NodePath<t.Class>) {\n      path.replaceWith(replacement);\n      return path.get(classPathDesc) as NodePath;\n    },\n  };\n}\n"],"mappings":"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"}